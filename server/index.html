<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<link href="./static_/styles.css" rel="stylesheet">
	<script src="./static_/jquery-2.1.4.min.js"></script>
	<script src="./static_/card_manipulations.js"></script>
	<script>
		var myHand = 0;
		var data = {
			'trump': null,
			'trump_suit': '',
			'turn': null,
			'hand1': 0,
			'hand2': [],
			'attack': [],
			'defense': [],
			'set': 52
		};

		function getCardValue(card) {
			return parseInt(new RegExp('[0-9]{1,2}').exec(card)[0], 10);
		}

		function getCardSuit(card) {
			return new RegExp('[A-Z]').exec(card)[0];
		}

		function more(Card1, Card2) {
			var Card1_v = getCardValue(Card1);
			var Card2_v = getCardValue(Card2);
			var Card1_s = getCardSuit(Card1);
			var Card2_s = getCardSuit(Card2);
			return (Card1_v > Card2_v && Card1_s == Card2_s ||
					Card1_s == data['trump_suit'] && Card2_s != data['trump_suit'])
		}

		function ajaxSuccess(jsondata) {
			for (var i = 0; i < jsondata.data.length; i++) {
				applyChange(jsondata.data[i]);
			}
			clearCards();
			if (data.turn == myHand) readyAttack();
			else readyDefense();
		}

		function init() {
			$.ajax({
						 dataType: 'json',
						 url: './api/init',
						 success: ajaxSuccess
					 });
		}

		function clearCards() {
			$(".cards").each(function (index, card) {
				$(card).unbind('click');
			});
		}

		function applyChange(change) {
			console.log(change);
			if (change['type'] == 'player_switch') {
				data['turn'] = change['player'];
			} else if (change['type'] == 'take_cards') {
				console.log('take_cards');
			}
			else if (change['type'] == 'set_decr') {
				data.set--;
				decrSet(data.set);
			}
			else if (change['type'] == 'trump_card') {
				data.trump = change['card'];
				setTrump(change['card']);
			}
			else if (change['type'] == 'get_card') {
				if (change['player'] == myHand) {
					data['hand2'].push(change['card']);
					addCard2(change['card']);
				}
				else {
					data.hand1++;
					addCard1();
				}
			} else if (change['type'] == 'attack') {
				if (myHand == change['player']) {
					data['hand2'].splice(data['hand2'].indexOf(change['card']), 1);
					delCard2(change['card']);
				}
				else {
					data['hand1']--;
					delCard1();
				}
				attack(change['card']);
				data['attack'].push(change['card']);
			} else if (change['type'] == 'defense') {
				if (myHand == change['player']) {
					data['hand2'].splice(data['hand2'].indexOf(change['card']), 1);
					delCard2(change['card']);
				}
				else {
					data['hand1']--;
					delCard1();
				}
				defense(change['card']);
				data['defense'].push(change['card']);
			} else if (change['type'] == 'table_clear') {
				$('#arena').empty();
			}
		}

		function readyAttack() {
			function onCardClick(eventObject) {
				console.log('click ' + eventObject.data.card);
				$.ajax({
							 dataType: 'json',
							 url: './api/attack?card=' + eventObject.data.card,
							 success: ajaxSuccess
						 });
			}

			$('#hand2').find('.card').each(function (index, card) {
				var res = false;
				var cards = $('#arena').find('.card');
				if (cards.length) {
					var card_v = getCardValue($(card).attr('value'));
					for (var i = 0; i < cards.length; i++) {
						if (card_v == getCardValue(cards.eq(i).attr('value'))) {
							res = true;
							break;
						}
					}
				} else {
					res = true;
				}
				$(card).animate({top: '0', opacity: '0.7'});
				if (res)
					$(card).animate({top: '-15', opacity: '1.0'}).click({card: index}, onCardClick);
			});

			var cancelCard = $("#cancel_card");
			cancelCard.unbind('click');
			if ($("#arena").find(".card").length) {
				cancelCard.click({card: -1}, onCardClick);
			}
		}

		function readyDefense() {
			function onCardClick(eventObject) {
				console.log('click ' + eventObject.data.card);
				$.ajax({
							 dataType: 'json',
							 url: './api/defense?card=' + eventObject.data.card,
							 success: ajaxSuccess
						 });
			}

			$('#hand2').find('.card').each(function (index, card) {
				var res = false;
				var arena = $('#arena');
				var card_str = $(card).attr('value');
				if (more(card_str, arena.find('.pair:last > .card:last').attr('value'))) {
					res = true;
				}
				$(card).animate({top: '0', opacity: '0.7'}).unbind('click');
				if (res)
					$(card).animate({top: '-15', opacity: '1.0'}).click({card: index}, onCardClick);

			});

			var cancelCard = $("#cancel_card");
			cancelCard.unbind('click');
			if ($("#arena").find(".card").length) {
				cancelCard.click({card: -1}, onCardClick);
			}
		}

		$(document).ready(
				function () {
					init();
				}
		)
	</script>
</head>
<body>
<div class="hidden">
	<div class="pair"></div>
	<div class="card">
		<div class="card_border">
			<img src="">
		</div>
	</div>
</div>
<div id="left">
	<button type="button" id="open_menu"></button>
	<div id="menu">
		1234
	</div>
</div>
<div id="table">
	<div id="hand1" class="hand"></div>
	<div id="arena"></div>
	<div id="hand2" class="hand"></div>
</div>
<div id="right">
	<div id="trump">
		<div class="card">
			<div class="card_border">
				<img src="">
			</div>
		</div>
	</div>
	<div id="set">
		<div class="card">
			<div class="card_border">
				<img src="./static_/svg/Blue_Back.svg">
			</div>
		</div>
		<div class="card">
			<div class="card_border">
				<img src="./static_/svg/Blue_Back.svg">
			</div>
		</div>
		<div class="card">
			<div class="card_border">
				<img src="./static_/svg/Blue_Back.svg">
			</div>
		</div>
		<div class="set_patch"></div>
	</div>
	<div id="cancel_card">
		<div class="card">
			<div class="card_border">
				<img src="./static_/svg/cancel.svg">
			</div>
		</div>
	</div>
</div>
</body>
</html>