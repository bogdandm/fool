<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/arbor.js"></script>
    <script>
        var images = {};

        function Renderer(canvas) {
            canvas = $(canvas).get(0);
            var ctx = canvas.getContext("2d");
            var particleSystem;

            var that = {
                init: function (system) {
                    //начальная инициализация
                    particleSystem = system;
                    particleSystem.screenSize(canvas.width, canvas.height);
                    particleSystem.screenPadding(80);
                    that.initMouseHandling();
                },

                redraw: function () {
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    particleSystem.eachEdge(
                            function (edge, pt1, pt2) {
                                ctx.strokeStyle = "rgba(0,0,0, .333)";
                                ctx.lineWidth = 1;
                                ctx.beginPath();
                                ctx.moveTo(pt1.x, pt1.y);
                                ctx.lineTo(pt2.x, pt2.y);
                                ctx.stroke();
                            });

                    particleSystem.eachNode(
                            function (node, pt) {
                                var w = 20;
                                ctx.fillStyle = "#1B2024";
                                ctx.fillRect(pt.x - (w + 4) / 2, pt.y - (w + 4) / 2, w + 4, w + 4);
                                ctx.drawImage(images[node.name], pt.x - w / 2, pt.y - w / 2, w, w);
                                ctx.fillStyle = "black";
                                ctx.font = 'italic 400 13px Roboto';
                                ctx.fillText (node.name, pt.x + 16, pt.y + 8);
                            });
                },
                initMouseHandling: function () { //события с мышью
                    var dragged = null;   //вершина которую перемещают
                    var handler = {
                        clicked: function (e) { //нажали
                            var pos = $(canvas).offset(); //получаем позицию canvas
                            _mouseP = arbor.Point(e.pageX - pos.left, e.pageY - pos.top); //и позицию нажатия кнопки относительно canvas
                            dragged = particleSystem.nearest(_mouseP); //определяем ближайшую вершину к нажатию
                            if (dragged.distance>25) {
                                dragged = null;
                                return;
                            }
                            if (dragged && dragged.node !== null) {
                                dragged.node.fixed = true; //фиксируем её
                            } else {
                                return;
                            }
                            $(canvas).bind('mousemove', handler.dragged); //слушаем события перемещения мыши
                            $(window).bind('mouseup', handler.dropped);  //и отпускания кнопки
                            return false;
                        },
                        dragged: function (e) { //перетаскиваем вершину
                            var pos = $(canvas).offset();
                            var s = arbor.Point(e.pageX - pos.left, e.pageY - pos.top);

                            if (dragged && dragged.node !== null) {
                                dragged.node.p = particleSystem.fromScreen(s); //тянем вершину за нажатой мышью
                            }

                            return false;
                        },
                        dropped: function (e) { //отпустили
                            if (dragged === null || dragged.node === undefined) return; //если не перемещали, то уходим
                            if (dragged.node !== null) dragged.node.fixed = false; //если перемещали - отпускаем
                            dragged = null; //очищаем
                            $(canvas).unbind('mousemove', handler.dragged); //перестаём слушать события
                            $(window).unbind('mouseup', handler.dropped);
                            _mouseP = null;
                            return false;
                        }
                    };
                    // слушаем события нажатия мыши
                    $(canvas).mousedown(handler.clicked);
                }
            };
            return that;
        }

        $(document).ready(function () {
            $("#viewport").attr({
                width: 800, //$(document).width() - 5,
                height: 600//$(document).height() - 5
            });
            sys = arbor.ParticleSystem(1000); // создаём систему
            sys.parameters({gravity: true}); // гравитация вкл
            sys.renderer = Renderer("#viewport"); //начинаем рисовать в выбраной области

            $.getJSON("/api/get_friends", //получаем с сервера файл с данными
                    function (data) {
                        $.each(data.nodes, function (i, node) {
                            pic = new Image();
                            pic.name = node.name;
                            $.ajax({
                                url: '/api/avatar?user=' + node.name,
                                success: function (data) {
                                    pic.src = data;
                                    pic.onload = function () {
                                        images[this.name] = this;
                                    };
                                },
                                async: false
                            });

                            sys.addNode(node.name); //добавляем вершину
                        });

                        $.each(data.edges, function (i, edge) {
                            sys.addEdge(sys.getNode(edge.src), sys.getNode(edge.dest)); //добавляем грань
                        });
                    });

        })


    </script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
<canvas id="viewport"></canvas>
</body>
</html>